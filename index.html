<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bicheando'pe - Cat谩logo Oficial</title>
  
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  
  <style>
    /* =========================================
       ESTILOS VISUALES (WEB) - IDNTICO A BASE 2.0
       ========================================= */
    :root { --zen-dark: #0d1117; --zen-primary: #2d5a4f; }
    body { background: #0d1117; font-family: 'Lora', serif; color: #f0f6f4; margin: 0; }

    .card-container { 
        background: #f0f6f4; border-radius: 12px; overflow: hidden; color: #0d1117;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4); height: 100%; display: flex; flex-direction: column; 
    }
    .card-image { height: 220px; background: #1a2a26; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .card-image img { width: 100%; height: 100%; object-fit: cover; }

    /* =========================================
       ESTILOS DEL PDF (MOTOR BASE 2.0)
       ========================================= */
    #pdf-overlay-root {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); z-index: 99999;
      overflow-y: scroll; display: none;
    }

    /* GRADIENTE OPACO: La clave para que no salga negro con backgroundColor: null */
    .pdf-sheet {
      width: 794px; height: 1122px; 
      background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 50%, #e0f2fe 100%) !important;
      margin: 20px auto;
      padding: 10px 30px; 
      color: black; position: relative; display: flex; flex-direction: column;
      box-shadow: 0 0 25px rgba(0,0,0,0.5);
    }

    /* Portadas de Cap铆tulo (NUEVO: Estilo para separar secciones) */
    .chapter-cover {
      flex-grow: 1; display: flex; flex-direction: column; 
      justify-content: center; align-items: center; text-align: center;
    }

    .pdf-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 340px); /* Altura fija Base 2.0 */
      gap: 10px; 
      flex-grow: 0; 
      height: auto; 
      margin-top: 5px;
      justify-content: center;
    }

    .pdf-card {
      border: 1px solid #ddd; border-radius: 5px;
      overflow: hidden; display: flex; flex-direction: column; height: 100%;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }

    .pdf-card-img {
      height: 185px; /* Altura Base 2.0 */
      width: 100%; background: #f0f0f0;
      display: flex; align-items: center; justify-content: center; overflow: hidden;
      border-bottom: 1px solid #eee;
    }
    .pdf-card-img img { width: 100%; height: 100%; object-fit: cover; }

    .pdf-body { 
      padding: 5px 6px; 
      flex-grow: 1; 
      display: flex; 
      flex-direction: column; 
    }

    .pdf-desc {
      font-size: 9px; line-height: 1.1; color: #444; 
      margin: 3px 0 2px 0; 
      flex-grow: 1; 
      overflow: hidden;
    }

    /* NUEVO: Precio inyectado en el espacio libre */
    .pdf-price {
      text-align: right; 
      font-size: 11px; 
      font-weight: bold; 
      color: #2d5a4f; 
      margin-bottom: 2px;
      margin-top: auto; /* Empuja hacia abajo aprovechando flex */
    }

    .pdf-footer {
      margin-top: 0; /* Base 2.0 */
      background: #f8fafc; border-top: 1px solid #e2e8f0;
      padding: 2px 4px; font-size: 8px; font-weight: bold;
      display: flex; justify-content: space-between; color: #334155;
    }

    .badge-pdf { padding: 1px 4px; border-radius: 3px; font-size: 7px; font-weight: bold; border: 1px solid #ccc; text-transform: uppercase; }
  </style>
</head>
<body>

  <div id="app">
    <header class="p-8 text-center border-b border-emerald-900" style="background: linear-gradient(135deg, #1a3a35 0%, #2d5a4f 100%);">
      <h1 class="text-5xl text-white font-serif mb-2">Bicheando'pe</h1>
      <p class="text-emerald-300 text-lg mb-6 italic">Cat谩logo de Colecci贸n</p>
      
      <button id="btn-pdf" onclick="generatePDF()" class="px-8 py-3 bg-white text-emerald-900 font-bold rounded-full shadow-lg hover:bg-emerald-50 transition cursor-pointer">
        GENERAR CATLOGO OFICIAL
      </button>
      <div id="loading-msg" class="mt-4 text-white font-bold hidden"></div>
    </header>

    <main class="max-w-7xl mx-auto p-8">
      <div id="web-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    </main>
  </div>

  <div id="pdf-overlay-root">
    <div id="pdf-content-zone"></div>
  </div>

  <script src="datos_isopodos.js"></script>

  <script>
    // 1. BASE DE DATOS MAESTRA (Con precios y categor铆as nuevas)
    const DB_MASTER = [
      // --- ISPODOS ---
      { id: 1, name: "Panda King Red", scientific: "Cubaris sp.", category: "Is贸podos", description: "Variante de coloraci贸n rojiza/arcilla. T铆midos y apreciados.", difficulty: "Media", temp_min: 24, temp_max: 28, hum_min: 70, hum_max: 80, price: 30, img: "img/panda_red.jpg" },
      { id: 2, name: "Panda King Black", scientific: "Cubaris sp.", category: "Is贸podos", description: "El cl谩sico is贸podo asi谩tico con patr贸n de oso panda.", difficulty: "Media", temp_min: 24, temp_max: 28, hum_min: 70, hum_max: 80, price: 18, img: "img/panda_black.jpg" },
      { id: 7, name: "Magic Potion", scientific: "Armadillidium vulgare", category: "Is贸podos", description: "Morfolog铆a japonesa, cuerpo transl煤cido y manchas amarillas.", difficulty: "F谩cil", temp_min: 18, temp_max: 26, hum_min: 50, hum_max: 60, price: 15, img: "img/magic.jpg" },
      { id: 10, name: "Glacier", scientific: "Cubaris murina", category: "Is贸podos", description: "Morfo blanco (albino) de la Little Sea. Prol铆ficos.", difficulty: "F谩cil", temp_min: 22, temp_max: 28, hum_min: 70, hum_max: 90, price: 20, img: "img/glacier.jpg" },
      { id: 9, name: "Little Sea", scientific: "Cubaris murina", category: "Is贸podos", description: "Cubaris resistente y adaptable. Tono azul gris谩ceo.", difficulty: "F谩cil", temp_min: 22, temp_max: 28, hum_min: 60, hum_max: 80, price: 14, img: "img/little_sea.jpg" },
      { id: 6, name: "Dairy Cow", scientific: "Porcellio laevis", category: "Is贸podos", description: "Grandes, r谩pidos y voraces. Reproducci贸n explosiva.", difficulty: "Muy F谩cil", temp_min: 18, temp_max: 28, hum_min: 40, hum_max: 60, price: 13, img: "img/dairy.jpg" },
      
      // Is贸podos "Consultar"
      { id: 3, name: "Amber Bee", scientific: "Cubaris sp.", category: "Is贸podos", description: "Peque帽os y activos con rayas amarillas y negras.", difficulty: "F谩cil", temp_min: 22, temp_max: 26, hum_min: 60, hum_max: 75, price: "Consultar", img: "img/amber.jpg" },
      { id: 12, name: "Powder Orange", scientific: "Porcellionides pruinosus", category: "Is贸podos", description: "Veloces y de textura 'empolvada'.", difficulty: "Muy F谩cil", temp_min: 20, temp_max: 28, hum_min: 50, hum_max: 75, price: "Consultar", img: "img/powder_orange.jpg" },
      { id: 4, name: "Spiky Isopod", scientific: "Cristarmadillidium muricatum", category: "Is贸podos", description: "Joya espa帽ola con espinas dorsales.", difficulty: "Media-Alta", temp_min: 20, temp_max: 25, hum_min: 50, hum_max: 60, price: "Consultar", img: "img/spiky.jpg" },
      { id: 5, name: "Zebra", scientific: "Armadillidium maculatum", category: "Is贸podos", description: "Patr贸n de rayas blancas y negras.", difficulty: "F谩cil", temp_min: 18, temp_max: 26, hum_min: 50, hum_max: 60, price: "Consultar", img: "img/zebra.jpg" },
      { id: 8, name: "Montenegro Clown", scientific: "Armadillidium klugii", category: "Is贸podos", description: "Tres filas de puntos y falda roja.", difficulty: "Media", temp_min: 21, temp_max: 27, hum_min: 40, hum_max: 50, price: "Consultar", img: "img/clown.jpg" },
      { id: 100, name: "White Shark", scientific: "Cubaris sp.", category: "Is贸podos", description: "Patr贸n tricolor exclusivo: rostro anaranjado.", difficulty: "Media", temp_min: 24, temp_max: 28, hum_min: 70, hum_max: 85, price: "Consultar", img: "img/white_shark.jpg" },

      // --- COLMBOLOS ---
      { id: 201, name: "Tropical White", scientific: "Collembola sp.", category: "Col茅mbolos", description: "Cultivo de col茅mbolos blancos. Pocas unidades.", difficulty: "F谩cil", temp_min: 20, temp_max: 28, hum_min: 80, hum_max: 99, price: 20, img: "img/col_white.jpg" },
      { id: 202, name: "Orange Springtail", scientific: "Yuukianura aphoruroides", category: "Col茅mbolos", description: "Naranjas de mayor tama帽o. Lentos y vistosos. (15u)", difficulty: "Media", temp_min: 22, temp_max: 26, hum_min: 70, hum_max: 90, price: 100, img: "img/col_orange.jpg" },
      { id: 203, name: "Yellow Springtail", scientific: "Collembola sp.", category: "Col茅mbolos", description: "Mini colonia de col茅mbolos amarillos. Raros.", difficulty: "Media", temp_min: 22, temp_max: 26, hum_min: 70, hum_max: 90, price: 70, img: "img/col_yellow.jpg" }
    ];

    // 2. RENDER WEB (Visualizaci贸n simple)
    let db = DB_MASTER;
    
    document.getElementById('web-grid').innerHTML = db.map(item => `
      <div class="card-container">
        <div class="card-image"><img src="${item.img}"></div>
        <div class="p-5 flex flex-col flex-grow">
          <div class="flex justify-between items-start">
            <h3 class="font-bold text-lg">${item.name}</h3>
            <span class="bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded">${item.price !== 'Consultar' ? 'S/ '+item.price : 'Consultar'}</span>
          </div>
          <p class="text-sm text-gray-600 italic mb-2">${item.category}</p>
          <p class="text-sm">${item.description}</p>
        </div>
      </div>
    `).join('');

    const toBase64 = url => fetch(url).then(r => r.blob()).then(b => new Promise((res, rej) => {
        const r = new FileReader(); r.onloadend = () => res(r.result); r.onerror = rej; r.readAsDataURL(b);
    })).catch(() => null); 

    // 3. GENERADOR PDF (L贸gica de Separaci贸n + Config Base 2.0)
    async function generatePDF() {
      const btn = document.getElementById('btn-pdf');
      const msg = document.getElementById('loading-msg');
      const overlay = document.getElementById('pdf-overlay-root');
      const container = document.getElementById('pdf-content-zone');

      btn.disabled = true; msg.classList.remove('hidden');
      msg.innerText = " Procesando im谩genes...";

      // NO tocamos el background del overlay, dejamos que el CSS del PDF mande
      overlay.style.display = 'block';

      try {
        const dbReady = await Promise.all(db.map(async (item) => {
          let finalImg = item.img;
          try { const b64 = await toBase64(item.img); if(b64) finalImg = b64; } catch(e){}
          return { ...item, finalImg };
        }));

        // Clasificaci贸n
        const isopodos = dbReady.filter(i => i.category === 'Is贸podos');
        const colembolos = dbReady.filter(i => i.category === 'Col茅mbolos');

        container.innerHTML = '';

        // --- MAQUETACIN ---
        
        // 1. Portada Principal
        addCoverPage(container, "Bicheando'pe", "Cat谩logo Oficial", new Date().toLocaleDateString());

        // 2. Secci贸n Is贸podos (con su Portada)
        if (isopodos.length > 0) {
          addChapterCover(container, "Is贸podos", "Variedad y Gen茅tica");
          addGridPages(container, isopodos, "Is贸podos");
        }

        // 3. Secci贸n Col茅mbolos (Separada con su Portada)
        if (colembolos.length > 0) {
          addChapterCover(container, "Col茅mbolos", "Especies Variadas");
          addGridPages(container, colembolos, "Col茅mbolos");
        }

        msg.innerText = " Renderizando PDF...";
        await new Promise(r => setTimeout(r, 1000)); 

        // CONFIGURACIN SAGRADA DEL CDIGO BASE 2.0
        // NO cambiar backgroundColor a white. Dejarlo en NULL.
        const opt = {
          margin: 0,
          filename: 'Catalogo_BicheandoPe_Oficial.pdf',
          image: { type: 'jpeg', quality: 0.95 },
          html2canvas: { 
              scale: 2, 
              useCORS: true, 
              scrollY: 0,
              backgroundColor: null // MANTENER AS PARA EVITAR PANTALLA NEGRA
          },
          jsPDF: { unit: 'px', format: [794, 1122], orientation: 'portrait' }
        };

        await html2pdf().set(opt).from(container).save();

      } catch (err) {
        alert("Error: " + err.message);
      } finally {
        overlay.style.display = 'none';
        btn.disabled = false; 
        msg.classList.add('hidden');
        btn.innerText = "GENERAR CATLOGO OFICIAL";
      }
    }

    // FUNCIONES HELPER
    function addCoverPage(c, t, s, d) {
      c.innerHTML += `<div class="pdf-sheet"><div class="chapter-cover">
        <h1 style="font-size:80px; color:#2d5a4f;">${t}</h1>
        <hr style="width:100px; height:5px; background:#2d5a4f; margin:30px auto;">
        <h2 style="font-size:40px;">${s}</h2><p>${d}</p>
      </div></div>`;
    }

    function addChapterCover(c, t, s) {
      c.innerHTML += `<div class="pdf-sheet"><div class="chapter-cover">
        <h1 style="font-size:60px; color:#1a3a35;">${t}</h1>
        <p style="font-size:24px; color:#2d5a4f; font-style:italic;">${s}</p>
      </div></div>`;
    }

    function addGridPages(container, items, section) {
      const itemsPerPage = 9; 
      for (let i = 0; i < items.length; i += itemsPerPage) {
        const chunk = items.slice(i, i + itemsPerPage);
        
        let cards = chunk.map(item => `
          <div class="pdf-card">
            <div class="pdf-card-img"><img src="${item.finalImg}" style="display:block;"></div>
            <div class="pdf-body">
              <div style="display:flex; justify-content:space-between; margin-bottom:1px;">
                <b style="font-size:11px;">${item.name}</b>
                <span class="badge-pdf">${item.difficulty || 'MEDIA'}</span>
              </div>
              <i style="font-size:9px; color:#2d5a4f; margin-bottom:1px;">${item.scientific}</i>
              <div class="pdf-desc">${item.description}</div>
              
              <div class="pdf-price">${typeof item.price === 'number' ? 'S/ '+item.price+'.00' : item.price}</div>
              
              <div class="pdf-footer">
                <span>T: ${item.temp_min}-${item.temp_max}掳C</span>
                <span>H: ${item.hum_min}-${item.hum_max}%</span>
              </div>
            </div>
          </div>`).join('');

        while (chunk.length < 9) { cards += `<div style="border:1px dashed #eee; background:transparent;"></div>`; chunk.push({}); }

        container.innerHTML += `
          <div class="pdf-sheet">
            <div style="border-bottom:2px solid #2d5a4f; margin-bottom:5px; display:flex; justify-content:space-between; height:20px; align-items:center;">
              <b style="color:#2d5a4f; font-size:14px;">${section}</b>
              <span style="font-size:10px;">P谩g ${Math.floor(i/9)+1}</span>
            </div>
            <div class="pdf-grid">${cards}</div>
            <div style="margin-top:auto; text-align:center; font-size:9px; color:#999; height:12px;">Bicheando'pe</div>
          </div>`;
      }
    }
  </script>
</body>
</html>
